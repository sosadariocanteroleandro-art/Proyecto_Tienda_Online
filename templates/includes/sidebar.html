<aside id="sidebar" class="sidebar-auto-expand fixed top-0 left-0 h-full z-50 overflow-visible group"
       x-data="{
           productos: false,
           marketing: false,
           ventas: false,
           perfil: false,
           isExpanded: false
       }"
       @mouseenter="isExpanded = true"
       @mouseleave="isExpanded = false; productos = false; marketing = false; ventas = false; perfil = false">

    <!-- Sidebar Container -->
    <div class="h-full transition-all duration-300 ease-in-out bg-white shadow-lg border-r border-gray-200"
         :class="isExpanded ? 'w-80' : 'w-16'">

        <!-- Header -->
        <div class="p-4 border-b border-gray-100">
            <div class="flex items-center">
                <!-- Logo Icon -->
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                    <span class="text-white font-bold text-sm">ğŸ›ï¸</span>
                </div>
                <!-- Title (only visible when expanded) -->
                <div x-show="isExpanded"
                     x-transition:enter="transition ease-out duration-200 delay-100"
                     x-transition:enter-start="opacity-0 transform translate-x-2"
                     x-transition:enter-end="opacity-100 transform translate-x-0"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0"
                     class="ml-3">
                    <h2 class="text-lg font-bold text-gray-900">Tu Tienda</h2>
                </div>
            </div>
        </div>

        <!-- Navigation Menu -->
        <nav class="p-3 space-y-1 overflow-y-auto h-full pb-32">

            <!-- PÃ¡gina de Inicio -->
            <a href="{% url 'usuarios:home' %}"
               class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-50 hover:text-blue-600 transition-all duration-200 group/item">
                <div class="w-5 h-5 flex-shrink-0 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                </div>
                <span x-show="isExpanded"
                      x-transition:enter="transition ease-out duration-200 delay-75"
                      x-transition:enter-start="opacity-0 transform translate-x-2"
                      x-transition:enter-end="opacity-100 transform translate-x-0"
                      x-transition:leave="transition ease-in duration-150"
                      x-transition:leave-start="opacity-100"
                      x-transition:leave-end="opacity-0"
                      class="ml-3 font-medium">Inicio</span>
            </a>

            {% if user.is_authenticated %}

            <!-- ============= MENÃš PRODUCTOS (DESPLEGABLE) ============= -->
            <div class="relative">
                <button @click="if(isExpanded) productos = !productos"
                        class="flex items-center w-full p-3 rounded-lg text-gray-700 hover:bg-gray-50 hover:text-blue-600 transition-all duration-200 group/item focus:outline-none">
                    <div class="w-5 h-5 flex-shrink-0 flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                    </div>
                    <div x-show="isExpanded" class="ml-3 flex items-center justify-between flex-1">
                        <span class="font-medium">Productos</span>
                        <svg class="w-4 h-4 transition-transform duration-200 text-gray-400"
                             :class="productos ? 'rotate-180' : ''"
                             fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </button>

                <!-- SubmenÃº Productos -->
                <div x-show="productos && isExpanded"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 max-h-0"
                     x-transition:enter-end="opacity-100 max-h-96"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100 max-h-96"
                     x-transition:leave-end="opacity-0 max-h-0"
                     class="ml-6 mt-1 space-y-1 overflow-hidden border-l-2 border-gray-100 pl-4">

                    {% if user.es_vendedor %}
                    <a href="{% url 'productos:mis_productos' %}"
                       class="block py-2 px-3 text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition duration-200">
                        Mis productos
                    </a>
                    <a href="{% url 'productos:mis_links_afiliado' %}"
                       class="block py-2 px-3 text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition duration-200">
                        Ãrea de Miembros
                    </a>
                    <a href="{% url 'productos:afiliarme' %}"
                       class="block py-2 px-3 text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition duration-200">
                        Afiliarse a producto
                    </a>
                    {% endif %}

                    <a href="{% url 'productos:home' %}"
                       class="block py-2 px-3 text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition duration-200">
                        CatÃ¡logo
                    </a>
                </div>
            </div>

            <!-- ============= MENÃš MARKETING (DESPLEGABLE) ============= -->
            {% if user.es_vendedor %}
            <div class="relative">
                <button @click="if(isExpanded) marketing = !marketing"
                        class="flex items-center w-full p-3 rounded-lg text-gray-700 hover:bg-gray-50 hover:text-blue-600 transition-all duration-200 group/item focus:outline-none">
                    <div class="w-5 h-5 flex-shrink-0 flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
                        </svg>
                    </div>
                    <div x-show="isExpanded" class="ml-3 flex items-center justify-between flex-1">
                        <span class="font-medium">Marketing</span>
                        <svg class="w-4 h-4 transition-transform duration-200 text-gray-400"
                             :class="marketing ? 'rotate-180' : ''"
                             fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </button>

                <!-- SubmenÃº Marketing -->
                <div x-show="marketing && isExpanded"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 max-h-0"
                     x-transition:enter-end="opacity-100 max-h-96"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100 max-h-96"
                     x-transition:leave-end="opacity-0 max-h-0"
                     class="ml-6 mt-1 space-y-1 overflow-hidden border-l-2 border-gray-100 pl-4">

                    <a href="{% url 'productos:mis_links_afiliado' %}"
                       class="block py-2 px-3 text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition duration-200">
                        Mis links
                    </a>
                    <a href="{% url 'productos:estadisticas_vendedor' %}"
                       class="block py-2 px-3 text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition duration-200">
                        EstadÃ­sticas
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- ============= MENÃš VENTAS (DESPLEGABLE) ============= -->
            <div class="relative">
                <button @click="if(isExpanded) ventas = !ventas"
                        class="flex items-center w-full p-3 rounded-lg text-gray-700 hover:bg-gray-50 hover:text-blue-600 transition-all duration-200 group/item focus:outline-none">
                    <div class="w-5 h-5 flex-shrink-0 flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                        </svg>
                    </div>
                    <div x-show="isExpanded" class="ml-3 flex items-center justify-between flex-1">
                        <span class="font-medium">Ventas</span>
                        <svg class="w-4 h-4 transition-transform duration-200 text-gray-400"
                             :class="ventas ? 'rotate-180' : ''"
                             fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </button>

                <!-- SubmenÃº Ventas -->
                <div x-show="ventas && isExpanded"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 max-h-0"
                     x-transition:enter-end="opacity-100 max-h-96"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100 max-h-96"
                     x-transition:leave-end="opacity-0 max-h-0"
                     class="ml-6 mt-1 space-y-1 overflow-hidden border-l-2 border-gray-100 pl-4">

                    {% if user.es_vendedor %}
                    <a href="{% url 'productos:estadisticas_vendedor' %}"
                       class="block py-2 px-3 text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition duration-200">
                        GestiÃ³n de ventas
                    </a>
                    <a href="{% url 'productos:mis_productos' %}"
                       class="block py-2 px-3 text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition duration-200">
                        Mis ventas
                    </a>
                    {% endif %}

                    <a href="{% url 'productos:mis_pedidos' %}"
                       class="block py-2 px-3 text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition duration-200">
                        Mis pedidos
                    </a>
                    <a href="{% url 'productos:ver_carrito' %}"
                       class="block py-2 px-3 text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition duration-200">
                        Mi carrito
                    </a>
                    <a href="{% url 'usuarios:comprador_dashboard' %}"
                       class="block py-2 px-3 text-sm text-blue-600 hover:text-blue-700 hover:bg-blue-50 rounded-lg transition duration-200 font-medium">
                        Ver mis compras
                    </a>
                </div>
            </div>

            <!-- ============= MENÃš CARTERA (DESPLEGABLE) ============= -->
            <div class="relative">
                <button @click="if(isExpanded) perfil = !perfil"
                        class="flex items-center w-full p-3 rounded-lg text-gray-700 hover:bg-gray-50 hover:text-blue-600 transition-all duration-200 group/item focus:outline-none">
                    <div class="w-5 h-5 flex-shrink-0 flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <div x-show="isExpanded" class="ml-3 flex items-center justify-between flex-1">
                        <span class="font-medium">Mi cuenta</span>
                        <svg class="w-4 h-4 transition-transform duration-200 text-gray-400"
                             :class="perfil ? 'rotate-180' : ''"
                             fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </button>

                <!-- SubmenÃº Cartera -->
                <div x-show="perfil && isExpanded"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 max-h-0"
                     x-transition:enter-end="opacity-100 max-h-96"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100 max-h-96"
                     x-transition:leave-end="opacity-0 max-h-0"
                     class="ml-6 mt-1 space-y-1 overflow-hidden border-l-2 border-gray-100 pl-4">

                    <a href="{% url 'usuarios:perfil' %}"
                       class="block py-2 px-3 text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition duration-200">
                        Mi perfil
                    </a>

                    {% if user.es_vendedor %}
                    <div class="py-2 px-3 text-sm text-green-600 font-medium bg-green-50 rounded-lg">
                        ğŸ’° Comisiones: â‚²{{ comisiones_totales|default:0 }}
                    </div>
                    {% endif %}

                    <a href="#" class="block py-2 px-3 text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition duration-200">
                        ConfiguraciÃ³n
                    </a>
                </div>
            </div>

            <!-- ============= SOLO SUPERUSUARIOS: Crear Producto ============= -->
            {% if user.is_superuser %}
            <div x-show="isExpanded" class="my-4">
                <div class="border-t border-gray-200"></div>
                <div class="px-3 py-2">
                    <span class="text-xs text-gray-500 uppercase tracking-wide font-medium">AdministraciÃ³n</span>
                </div>
            </div>

            <div class="relative">
                <a href="{% url 'productos:crear_producto' %}"
                   class="flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-50 hover:text-blue-600 transition-all duration-200 group/item">
                    <div class="w-5 h-5 flex-shrink-0 flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </div>
                    <span x-show="isExpanded" class="ml-3 font-medium">Crear Producto</span>
                </a>
            </div>
            {% endif %}

            <!-- ============= PROMOCIÃ“N PARA COMPRADORES ============= -->
            {% if not user.es_vendedor %}
            <div x-show="isExpanded" class="mt-6 pt-4 border-t border-gray-200">
                {% if user.referido_por %}
                <!-- Banner promocional para referidos -->
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-4 mb-4 text-center">
                    <h4 class="font-bold text-white text-sm mb-1">ğŸ‰ Â¡Fuiste Invitado!</h4>
                    <p class="text-blue-100 text-xs mb-2">Por {{ user.referido_por.nombre }}</p>
                    <a href="{% url 'usuarios:upgrade_vendedor' %}"
                       class="bg-white text-blue-600 px-3 py-2 rounded-lg font-semibold text-xs hover:bg-blue-50 transition duration-300 block">
                        ğŸ’° Â¡Quiero ser Vendedor!
                    </a>
                </div>
                {% else %}
                <a href="{% url 'usuarios:upgrade_vendedor' %}"
                   class="flex items-center py-3 px-4 rounded-lg bg-blue-600 hover:bg-blue-700 transition duration-300 group mb-3 text-white">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <span class="font-semibold">Gestionar mi negocio</span>
                </a>
                {% endif %}
            </div>
            {% endif %}

            <!-- ============= SECCIÃ“N INFERIOR ============= -->
            <div class="absolute bottom-0 left-0 right-0 p-4 bg-gray-50 border-t border-gray-200">
                <!-- Info del usuario -->
                <div class="flex items-center mb-3">
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-white text-sm font-bold">{{ user.username|first|upper }}</span>
                    </div>
                    <div x-show="isExpanded" class="ml-3 flex-1 min-w-0">
                        <div class="text-sm font-medium text-gray-900 truncate">{{ user.username }}</div>
                        <div class="text-xs text-gray-500">
                            {% if user.es_vendedor %}
                                {% if user.is_superuser %}
                                    Admin
                                {% else %}
                                    Vendedor
                                {% endif %}
                            {% else %}
                                Comprador
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Logout Button -->
                <form action="{% url 'usuarios:logout' %}" method="post">
                    {% csrf_token %}
                    <button type="submit"
                            class="w-full flex items-center p-2 text-red-600 hover:bg-red-50 hover:text-red-700 rounded-lg transition-all duration-200 group/item">
                        <div class="w-5 h-5 flex-shrink-0 flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                        </div>
                        <span x-show="isExpanded" class="ml-3 font-medium">Cerrar sesiÃ³n</span>
                    </button>
                </form>
            </div>

            {% else %}
            <!-- ============= SECCIÃ“N PARA NO AUTENTICADOS ============= -->
            <div x-show="isExpanded" class="mt-6 px-4">
                <div class="text-center mb-4">
                    <p class="text-gray-600 text-sm mb-3">Â¿Quieres ganar dinero vendiendo?</p>
                </div>
                <a href="{% url 'usuarios:registro' %}"
                   class="block w-full bg-blue-600 text-white font-semibold px-4 py-3 rounded-lg shadow hover:bg-blue-700 transition duration-300 text-center mb-3">
                    ğŸš€ Registrarse
                </a>
                <a href="{% url 'usuarios:login' %}"
                   class="block w-full bg-transparent border border-gray-300 text-gray-700 font-semibold px-4 py-3 rounded-lg hover:bg-gray-50 transition duration-300 text-center">
                    ğŸ” Iniciar SesiÃ³n
                </a>
            </div>
            {% endif %}
        </nav>
    </div>
</aside>
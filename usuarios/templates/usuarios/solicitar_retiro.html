{% extends 'base.html' %}
{% load static %}

{% block title %}Solicitar Retiro - {{ block.super }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <main class="transition-all duration-300">
        <div class="container mx-auto px-4 py-8 max-w-2xl">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">üí∏ Solicitar Retiro</h1>
                <p class="text-gray-600 mt-2">Retira tus comisiones ganadas</p>
            </div>

            <!-- Mensajes de √©xito/error -->
            {% if messages %}
                {% for message in messages %}
                <div class="mb-4 p-4 rounded-lg {% if message.tags == 'success' %}bg-green-100 border border-green-300 text-green-800{% elif message.tags == 'error' %}bg-red-100 border border-red-300 text-red-800{% else %}bg-blue-100 border border-blue-300 text-blue-800{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            {% endif %}

            <!-- ============= FORMULARIO DE SOLICITUD ============= -->
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <!-- Resumen de saldo -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-green-800">Saldo Disponible</h3>
                            <div class="text-2xl font-bold text-green-600">‚Ç≤{{ saldo_disponible|floatformat:0 }}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-green-700">Retiro m√≠nimo</div>
                            <div class="font-semibold text-green-800">‚Ç≤{{ retiro_minimo|floatformat:0 }}</div>
                        </div>
                    </div>
                </div>

                <!-- M√©todo de retiro configurado -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h4 class="font-semibold text-blue-800 mb-2">M√©todo de Retiro Configurado</h4>
                    <div class="flex items-center justify-between">
                        <div class="text-blue-700">
                            {{ user.get_tipo_retiro_display_custom }}
                            {% if user.tipo_retiro == 'banco' %}
                                <div class="text-sm">{{ user.banco_nombre }} - {{ user.numero_cuenta }}</div>
                            {% else %}
                                <div class="text-sm">{{ user.numero_celular_retiro }}</div>
                            {% endif %}
                        </div>
                        <a href="{% url 'usuarios:mi_saldo' %}" class="text-blue-600 hover:text-blue-700 text-sm">
                            Cambiar m√©todo
                        </a>
                    </div>
                </div>

                <!-- Formulario de solicitud -->
                <form method="post" class="space-y-6">
                    {% csrf_token %}
                    
                    <div>
                        <label for="monto" class="block text-sm font-semibold text-gray-600 mb-2">
                            Monto a Retirar (‚Ç≤)
                        </label>
                        <input type="number" 
                               id="monto" 
                               name="monto" 
                               min="{{ retiro_minimo }}"
                               max="{{ saldo_disponible }}"
                               step="1000"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-lg font-semibold"
                               placeholder="Ingresa el monto"
                               required>
                        
                        <!-- Botones r√°pidos -->
                        <div class="mt-2 flex flex-wrap gap-2">
                            {% if saldo_disponible >= retiro_minimo %}
                            <button type="button" 
                                    onclick="document.getElementById('monto').value = {{ retiro_minimo }}"
                                    class="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm rounded-lg transition">
                                M√≠nimo (‚Ç≤{{ retiro_minimo|floatformat:0 }})
                            </button>
                            {% endif %}
                            
                            {% if saldo_disponible >= 100000 %}
                            <button type="button" 
                                    onclick="document.getElementById('monto').value = 100000"
                                    class="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm rounded-lg transition">
                                ‚Ç≤100,000
                            </button>
                            {% endif %}
                            
                            {% if saldo_disponible >= 200000 %}
                            <button type="button" 
                                    onclick="document.getElementById('monto').value = 200000"
                                    class="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm rounded-lg transition">
                                ‚Ç≤200,000
                            </button>
                            {% endif %}
                            
                            <button type="button" 
                                    onclick="document.getElementById('monto').value = {{ saldo_disponible|floatformat:0 }}"
                                    class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 text-sm rounded-lg transition">
                                Todo (‚Ç≤{{ saldo_disponible|floatformat:0 }})
                            </button>
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-2">
                            Monto disponible: ‚Ç≤{{ saldo_disponible|floatformat:0 }}
                        </p>
                    </div>
                    
                    <!-- Informaci√≥n importante -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h4 class="font-semibold text-yellow-800 mb-2">‚ö†Ô∏è Informaci√≥n Importante</h4>
                        <ul class="text-sm text-yellow-700 space-y-1">
                            <li>‚Ä¢ El procesamiento del retiro puede tomar 1-3 d√≠as h√°biles</li>
                            <li>‚Ä¢ Te contactaremos por email para confirmar el pago</li>
                            <li>‚Ä¢ Verifica que tus datos de contacto est√©n actualizados</li>
                            <li>‚Ä¢ Una vez enviada, la solicitud no se puede cancelar</li>
                        </ul>
                    </div>
                    
                    <!-- T√©rminos y condiciones -->
                    <div class="flex items-start space-x-3">
                        <input type="checkbox" 
                               id="acepto_terminos" 
                               name="acepto_terminos"
                               class="mt-1 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                               required>
                        <label for="acepto_terminos" class="text-sm text-gray-600">
                            Acepto los t√©rminos y condiciones de retiro. Confirmo que los datos proporcionados son correctos y 
                            entiendo que el procesamiento puede tomar hasta 3 d√≠as h√°biles.
                        </label>
                    </div>
                    
                    <!-- Botones de acci√≥n -->
                    <div class="flex space-x-4 pt-6">
                        <button type="submit" 
                                class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                            üí∏ Confirmar Solicitud de Retiro
                        </button>
                        
                        <a href="{% url 'usuarios:mi_saldo' %}" 
                           class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg text-center transition duration-300">
                            ‚ùå Cancelar
                        </a>
                    </div>
                </form>
            </div>
            
            <!-- Informaci√≥n adicional -->
            <div class="mt-8 text-center">
                <div class="bg-white rounded-lg p-4 shadow">
                    <h4 class="font-semibold text-gray-800 mb-2">üí° ¬øNecesitas ayuda?</h4>
                    <p class="text-sm text-gray-600">
                        Si tienes problemas con tu solicitud de retiro, cont√°ctanos por WhatsApp o email.
                    </p>
                    <div class="mt-2 space-x-4">
                        <span class="text-xs text-gray-500">WhatsApp: +595 981 123 456</span>
                        <span class="text-xs text-gray-500">Email: soporte@tutienda.com</span>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const montoInput = document.getElementById('monto');
    const saldoDisponible = {{ saldo_disponible }};
    const retiroMinimo = {{ retiro_minimo }};
    
    // Validar monto en tiempo real
    montoInput.addEventListener('input', function() {
        const valor = parseFloat(this.value) || 0;
        
        if (valor > saldoDisponible) {
            this.setCustomValidity(`No puedes retirar m√°s de ‚Ç±${saldoDisponible.toLocaleString()}`);
        } else if (valor < retiroMinimo && valor > 0) {
            this.setCustomValidity(`El monto m√≠nimo es ‚Ç±${retiroMinimo.toLocaleString()}`);
        } else {
            this.setCustomValidity('');
        }
    });
    
    // Formatear n√∫mero con separadores de miles
    montoInput.addEventListener('blur', function() {
        const valor = parseFloat(this.value) || 0;
        if (valor > 0) {
            this.value = Math.round(valor);
        }
    });
});
</script>
{% endblock %}
{% extends 'base.html' %}
{% load humanize %}

{% block title %}Confirmar Pedido - Tu Tienda{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-8 text-center">
        💳 Confirmar tu Pedido
    </h1>

    <!-- Mensajes -->
    {% if messages %}
    <div class="mb-6">
        {% for message in messages %}
        <div class="p-4 rounded-lg mb-2 {% if message.tags == 'success' %}bg-green-100 text-green-800{% elif message.tags == 'error' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <form enctype="multipart/form-data" id="checkout-form" method="post">
        {% csrf_token %}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Columna Izquierda: Formulario -->
            <div class="lg:col-span-2 space-y-6">

                <!-- PASO 1: SELECCIONAR MÉTODO DE PAGO -->
                <div class="glass-card rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">💳 Selecciona tu Método de Pago</h2>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Pago contra entrega -->
                        <label class="payment-option border-2 border-gray-300 rounded-xl p-4 text-center">
                            <input class="hidden" name="metodo_pago" required type="radio" value="CONTRA_ENTREGA">
                            <div class="text-4xl mb-2">💵</div>
                            <div class="font-bold text-gray-800">Pago en Puerta</div>
                            <div class="text-xs text-gray-600 mt-1">Paga al recibir</div>
                        </label>

                        <!-- Transferencia -->
                        <label class="payment-option border-2 border-gray-300 rounded-xl p-4 text-center">
                            <input class="hidden" name="metodo_pago" required type="radio" value="TRANSFERENCIA">
                            <div class="text-4xl mb-2">🏦</div>
                            <div class="font-bold text-gray-800">Transferencia</div>
                            <div class="text-xs text-gray-600 mt-1">Sube comprobante</div>
                        </label>

                        <!-- Tarjeta (deshabilitado) -->
                        <label class="payment-option disabled border-2 border-gray-300 rounded-xl p-4 text-center">
                            <input class="hidden" disabled name="metodo_pago" type="radio" value="TARJETA">
                            <div class="text-4xl mb-2">💳</div>
                            <div class="font-bold text-gray-800">Tarjeta</div>
                            <div class="text-xs text-gray-600 mt-1">Próximamente</div>
                        </label>
                    </div>
                </div>

                <!-- PASO 2: DATOS DEL CLIENTE -->
                <div class="glass-card rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">📋 Tus Datos</h2>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Nombre Completo <span class="text-red-500">*</span>
                            </label>
                            <input class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-4 focus:ring-blue-200 focus:border-blue-500" name="nombre_completo" placeholder="Juan Pérez"
                                   required
                                   type="text"
                                   value="{{ request.user.get_full_name }}">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Email <span class="text-red-500">*</span>
                                </label>
                                <input class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-4 focus:ring-blue-200 focus:border-blue-500" name="email" placeholder="juan@email.com"
                                       required
                                       type="email"
                                       value="{{ request.user.email }}">
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Teléfono <span class="text-red-500">*</span>
                                </label>
                                <input class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-4 focus:ring-blue-200 focus:border-blue-500" name="telefono" placeholder="+595 981 234567"
                                       required
                                       type="tel">
                            </div>
                        </div>

                        <!-- Dirección (se muestra solo si NO es solo digitales O si elige contra entrega) -->
                        <div %} %}style="display: none;" endif id="direccion-section" if solo_digitales {% {%>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        Ciudad <span class="text-red-500" id="ciudad-required">*</span>
                                    </label>
                                    <input %} %}required{% endif
                                           id="ciudad-input" if name="ciudad" not solo_digitales type="text" {%
                                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-4 focus:ring-blue-200 focus:border-blue-500"
                                           placeholder="Asunción">
                                </div>

                            <div class="mt-4">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        Dirección de Entrega <span class="text-red-500" id="direccion-required">*</span>
                                    </label>
                                <textarea %} %}required{%
                                          endif id="direccion-input" if name="direccion_envio" not rows="3" solo_digitales
                                          {%
                                              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-4 focus:ring-blue-200 focus:border-blue-500"
                                              placeholder="Calle, número, barrio, referencias..."></textarea>
                                </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Notas adicionales (opcional)
                            </label>
                            <textarea class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-4 focus:ring-blue-200 focus:border-blue-500" name="notas"
                                      placeholder="Alguna indicación especial..."
                                      rows="2"></textarea>
                        </div>
                    </div>
                </div>

                <!-- PASO 3: INFORMACIÓN DE TRANSFERENCIA (solo si elige transferencia) -->
                <div class="glass-card rounded-2xl shadow-xl p-6" id="transferencia-section" style="display: none;">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">🏦 Datos para Transferencia</h2>

                    {% if config_pagos %}
                    <div class="bg-blue-50 p-6 rounded-lg mb-6">
                        <div class="space-y-3 text-gray-700">
                            <div class="flex justify-between border-b pb-2">
                                <span class="font-semibold">Banco:</span>
                                <span class="text-right">{{ config_pagos.banco_nombre }}</span>
                            </div>
                            <div class="flex justify-between border-b pb-2">
                                <span class="font-semibold">Cuenta:</span>
                                <span class="text-right font-mono">{{ config_pagos.banco_cuenta }}</span>
                            </div>
                            <div class="flex justify-between border-b pb-2">
                                <span class="font-semibold">Titular:</span>
                                <span class="text-right">{{ config_pagos.banco_titular }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-semibold">CI/RUC:</span>
                                <span class="text-right">{{ config_pagos.banco_cedula }}</span>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6">
                        <p class="text-yellow-800">
                            <strong>Nota:</strong> Los datos bancarios serán proporcionados por el vendedor.
                        </p>
                    </div>
                    {% endif %}

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Subir Comprobante de Pago <span class="text-red-500">*</span>
                        </label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 bg-gray-50 hover:bg-gray-100 transition duration-200">
                            <input accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-6 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 file:cursor-pointer cursor-pointer" id="comprobante-input" name="comprobante_pago"
                                   type="file">
                            <p class="text-xs text-gray-500 mt-2">
                                💡 Sube una foto clara del comprobante de transferencia (JPG, PNG)
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Botón de Confirmar -->
                <button class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-4 px-8 rounded-xl text-lg shadow-xl transition duration-300 transform hover:scale-105"
                        type="submit">
                    ✅ Confirmar Pedido
                </button>
            </div>

            <!-- Columna Derecha: Resumen -->
            <div class="lg:col-span-1">
                <div class="glass-card rounded-2xl shadow-xl p-6 sticky top-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">📦 Resumen del Pedido</h2>

                    <!-- Productos -->
                    <div class="space-y-3 mb-6 max-h-64 overflow-y-auto">
                        {% for item in items %}
                        <div class="flex gap-3 pb-3 border-b">
                            <img alt="{{ item.producto.nombre }}" class="w-16 h-16 object-cover rounded-lg"
                                 onerror="this.src='https://placehold.co/100x100/667eea/fff?text=P'"
                                 src="{{ item.producto.imagen.url }}">
                            <div class="flex-1">
                                <p class="font-semibold text-sm text-gray-800">{{ item.producto.nombre }}</p>
                                <p class="text-xs text-gray-500">Cantidad: {{ item.cantidad }}</p>
                                <p class="text-sm font-bold text-green-600">₲{{ item.subtotal|intcomma }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Total -->
                    <div class="space-y-2 mb-4 pb-4 border-b">
                        <div class="flex justify-between text-gray-600">
                            <span>Subtotal:</span>
                            <span>₲{{ carrito.total|intcomma }}</span>
                        </div>
                        <div class="flex justify-between text-gray-600">
                            <span>Items:</span>
                            <span>{{ items|length }}</span>
                        </div>
                    </div>

                    <div class="flex justify-between text-2xl font-bold text-green-600 mb-4">
                        <span>Total:</span>
                        <span>₲{{ carrito.total|intcomma }}</span>
                    </div>

                    <div class="text-xs text-gray-500 space-y-1">
                        <p>✅ Compra 100% segura</p>
                        <p id="resumen-metodo">💡 Selecciona tu método de pago</p>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Botón Volver -->
    <div class="mt-8 text-center">
        <a class="inline-block bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-8 rounded-full transition duration-300"
           href="{% url 'productos:ver_carrito' %}">
            ← Volver al Carrito
        </a>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .payment-option {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .payment-option:hover:not(.disabled) {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    .payment-option.selected {
        border-color: #3b82f6 !important;
        background: #eff6ff !important;
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.2);
    }
    .payment-option.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    const soloDigitales = {{ solo_digitales|yesno:"true,false" }};

    // Manejar selección de método de pago
    document.querySelectorAll('input[name="metodo_pago"]').forEach(radio => {
        radio.addEventListener('change', function() {
            // Remover selección visual de todos
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Agregar selección visual al seleccionado
            const selectedLabel = this.closest('.payment-option');
            selectedLabel.classList.add('selected');

            // Manejar visibilidad de secciones
            const transferencia = document.getElementById('transferencia-section');
            const direccion = document.getElementById('direccion-section');
            const comprobanteInput = document.getElementById('comprobante-input');
            const ciudadInput = document.getElementById('ciudad-input');
            const direccionInput = document.getElementById('direccion-input');
            const resumenMetodo = document.getElementById('resumen-metodo');

            if (this.value === 'TRANSFERENCIA') {
                transferencia.style.display = 'block';
                comprobanteInput.required = true;
                resumenMetodo.textContent = '🏦 Transferencia bancaria';

                // Dirección obligatoria si hay físicos
                if (!soloDigitales) {
                    direccion.style.display = 'block';
                    ciudadInput.required = true;
                    direccionInput.required = true;
                }
            } else if (this.value === 'CONTRA_ENTREGA') {
                transferencia.style.display = 'none';
                comprobanteInput.required = false;
                direccion.style.display = 'block';
                ciudadInput.required = true;
                direccionInput.required = true;
                resumenMetodo.textContent = '💵 Pago en puerta';
            } else {
                transferencia.style.display = 'none';
                comprobanteInput.required = false;
                resumenMetodo.textContent = '💳 Pago con tarjeta';

                if (!soloDigitales) {
                    direccion.style.display = 'block';
                    ciudadInput.required = true;
                    direccionInput.required = true;
                }
            }
        });
    });

    // Validación del formulario
    document.getElementById('checkout-form').addEventListener('submit', function(e) {
        const metodoSeleccionado = document.querySelector('input[name="metodo_pago"]:checked');

        if (!metodoSeleccionado) {
            e.preventDefault();
            alert('Por favor, selecciona un método de pago');
            return false;
        }

        if (metodoSeleccionado.value === 'TRANSFERENCIA') {
            const comprobante = document.getElementById('comprobante-input');
            if (!comprobante.files.length) {
                e.preventDefault();
                alert('Por favor, sube el comprobante de pago');
                return false;
            }
        }
    });
</script>
{% endblock %}
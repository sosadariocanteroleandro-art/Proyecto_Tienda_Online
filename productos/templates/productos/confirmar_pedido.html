{% extends 'base.html' %}
{% load humanize %}

{% block title %}Confirmar Pedido - Tu Tienda{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-8 text-center">
        üí≥ Confirmar tu Pedido
    </h1>

    <!-- Mensajes -->
    {% if messages %}
    <div class="mb-6">
        {% for message in messages %}
        <div class="p-4 rounded-lg mb-2 {% if message.tags == 'success' %}bg-green-100 text-green-800{% elif message.tags == 'error' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <form enctype="multipart/form-data" method="post" id="pedido-form">
        {% csrf_token %}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Columna Izquierda: Formulario -->
            <div class="lg:col-span-2 space-y-6">

                <!-- PASO 1: SELECCIONAR M√âTODO DE PAGO -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üí≥ Selecciona tu M√©todo de Pago</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Pago contra entrega -->
                        <label class="metodo-pago block p-4 border-2 border-gray-300 rounded-xl cursor-pointer hover:border-green-500 transition-all duration-300">
                            <input type="radio" name="metodo_pago" value="CONTRA_ENTREGA" class="sr-only" onchange="cambiarMetodo('CONTRA_ENTREGA')">
                            <div class="text-center">
                                <div class="text-4xl mb-2">üíµ</div>
                                <div class="font-bold text-gray-800">Pago en Puerta</div>
                                <div class="text-xs text-gray-600 mt-1">Paga cuando recibas el producto</div>
                            </div>
                        </label>

                        <!-- Transferencia -->
                        <label class="metodo-pago block p-4 border-2 border-gray-300 rounded-xl cursor-pointer hover:border-blue-500 transition-all duration-300">
                            <input type="radio" name="metodo_pago" value="TRANSFERENCIA" class="sr-only" onchange="cambiarMetodo('TRANSFERENCIA')">
                            <div class="text-center">
                                <div class="text-4xl mb-2">üè¶</div>
                                <div class="font-bold text-gray-800">Transferencia Bancaria</div>
                                <div class="text-xs text-gray-600 mt-1">Transfiere y sube comprobante</div>
                            </div>
                        </label>
                    </div>

                    <!-- Estado del m√©todo seleccionado -->
                    <div id="metodo-estado" class="mt-4 p-3 rounded-lg hidden">
                        <p id="metodo-mensaje" class="text-sm font-medium"></p>
                    </div>
                </div>

                <!-- PASO 2: DATOS PERSONALES -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üìã Tus Datos</h2>

                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Nombre Completo <span class="text-red-500">*</span>
                                </label>
                                <input type="text" name="nombre_completo" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="Tu nombre completo"
                                       value="{{ request.user.get_full_name|default:request.user.username }}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Tel√©fono <span class="text-red-500">*</span>
                                </label>
                                <input type="tel" name="telefono" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="+595 981 234567">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Email <span class="text-red-500">*</span>
                            </label>
                            <input type="email" name="email" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="tu@email.com"
                                   value="{{ request.user.email }}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Notas (opcional)</label>
                            <textarea name="notas" rows="2"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                      placeholder="Alguna indicaci√≥n especial..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- PASO 3: DIRECCI√ìN (se muestra cuando es necesaria) -->
                <div id="seccion-direccion" class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üìç Direcci√≥n de Entrega</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Ciudad <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="ciudad" id="ciudad"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="Asunci√≥n, Ciudad del Este, etc.">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Direcci√≥n <span class="text-red-500">*</span>
                            </label>
                            <textarea name="direccion_envio" id="direccion" rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                      placeholder="Calle, n√∫mero, barrio, referencias..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- PASO 4: TRANSFERENCIA (se muestra solo para transferencia) -->
                <div id="seccion-transferencia" class="bg-white rounded-2xl shadow-xl p-6" style="display: none;">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üè¶ Transferencia Bancaria</h2>

                    <!-- Datos bancarios -->
                    {% if config_pagos and config_pagos.banco_nombre %}
                    <div class="bg-blue-50 p-6 rounded-lg mb-6">
                        <h3 class="text-lg font-bold text-blue-900 mb-4">üí∞ Transfiere exactamente ‚Ç≤{{ carrito.total|intcomma }} a:</h3>
                        <div class="space-y-2">
                            <p><strong>Banco:</strong> {{ config_pagos.banco_nombre }}</p>
                            <p><strong>Cuenta:</strong> {{ config_pagos.banco_cuenta }}</p>
                            <p><strong>Titular:</strong> {{ config_pagos.banco_titular }}</p>
                            {% if config_pagos.banco_cedula %}
                            <p><strong>CI/RUC:</strong> {{ config_pagos.banco_cedula }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Subir comprobante -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Comprobante de Pago <span class="text-red-500">*</span>
                        </label>
                        <input type="file" name="comprobante_pago" id="comprobante" accept="image/*"
                               class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700">
                        <p class="text-xs text-gray-500 mt-1">Sube una foto clara del comprobante</p>
                    </div>
                </div>

                <!-- Bot√≥n de confirmaci√≥n -->
                <button type="submit" id="btn-confirmar"
                        class="w-full bg-gray-400 text-white font-bold py-4 px-8 rounded-xl text-lg transition duration-300"
                        disabled>
                    Selecciona un m√©todo de pago
                </button>
            </div>

            <!-- Columna Derecha: Resumen -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-xl p-6 sticky top-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üì¶ Resumen</h2>

                    <div class="space-y-3 mb-6">
                        {% for item in items %}
                        <div class="flex gap-3 pb-3 border-b">
                            <img src="{{ item.producto.imagen.url }}" alt="{{ item.producto.nombre }}"
                                 class="w-12 h-12 object-cover rounded">
                            <div class="flex-1">
                                <p class="font-semibold text-sm">{{ item.producto.nombre }}</p>
                                <p class="text-xs text-gray-500">Cantidad: {{ item.cantidad }}</p>
                                <p class="text-sm font-bold text-green-600">‚Ç≤{{ item.subtotal|intcomma }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="flex justify-between text-xl font-bold text-green-600 mb-4">
                        <span>Total:</span>
                        <span>‚Ç≤{{ carrito.total|intcomma }}</span>
                    </div>

                    <div id="resumen-metodo" class="text-sm text-gray-500 text-center">
                        üí° Selecciona tu m√©todo de pago
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Variables globales
const soloDigitales = {{ solo_digitales|yesno:"true,false" }};
let metodoActual = null;

// Funci√≥n principal para cambiar m√©todo
function cambiarMetodo(metodo) {
    console.log('üîÑ Cambio a m√©todo:', metodo);
    metodoActual = metodo;

    // Actualizar estilos visuales
    actualizarEstilos(metodo);

    // Configurar secciones
    configurarSecciones(metodo);

    // Actualizar bot√≥n
    actualizarBoton(metodo);

    // Mostrar mensaje
    mostrarMensaje(metodo);

    console.log('‚úÖ M√©todo configurado:', metodo);
}

function actualizarEstilos(metodo) {
    // Limpiar estilos
    document.querySelectorAll('.metodo-pago').forEach(el => {
        el.classList.remove('border-blue-500', 'bg-blue-50', 'border-green-500', 'bg-green-50');
        el.classList.add('border-gray-300');
    });

    // Aplicar estilo al seleccionado
    const input = document.querySelector(`input[value="${metodo}"]`);
    if (input) {
        const label = input.closest('.metodo-pago');
        if (metodo === 'TRANSFERENCIA') {
            label.classList.remove('border-gray-300');
            label.classList.add('border-blue-500', 'bg-blue-50');
        } else if (metodo === 'CONTRA_ENTREGA') {
            label.classList.remove('border-gray-300');
            label.classList.add('border-green-500', 'bg-green-50');
        }
    }
}

function configurarSecciones(metodo) {
    const seccionDireccion = document.getElementById('seccion-direccion');
    const seccionTransferencia = document.getElementById('seccion-transferencia');
    const ciudad = document.getElementById('ciudad');
    const direccion = document.getElementById('direccion');
    const comprobante = document.getElementById('comprobante');

    // Resetear required
    if (ciudad) ciudad.required = false;
    if (direccion) direccion.required = false;
    if (comprobante) comprobante.required = false;

    if (metodo === 'TRANSFERENCIA') {
        // Mostrar transferencia
        seccionTransferencia.style.display = 'block';
        if (comprobante) comprobante.required = true;

        // Direcci√≥n seg√∫n productos
        if (!soloDigitales) {
            seccionDireccion.style.display = 'block';
            if (ciudad) ciudad.required = true;
            if (direccion) direccion.required = true;
        } else {
            seccionDireccion.style.display = 'none';
        }

    } else if (metodo === 'CONTRA_ENTREGA') {
        // Ocultar transferencia
        seccionTransferencia.style.display = 'none';

        // Siempre mostrar direcci√≥n para contra entrega
        seccionDireccion.style.display = 'block';
        if (ciudad) ciudad.required = true;
        if (direccion) direccion.required = true;
    }
}

function actualizarBoton(metodo) {
    const btn = document.getElementById('btn-confirmar');
    if (!btn) return;

    btn.disabled = false;
    btn.classList.remove('bg-gray-400');

    if (metodo === 'TRANSFERENCIA') {
        btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        btn.textContent = 'üí∞ Confirmar Pedido con Transferencia';
    } else if (metodo === 'CONTRA_ENTREGA') {
        btn.classList.add('bg-green-600', 'hover:bg-green-700');
        btn.textContent = 'üöö Confirmar Pedido - Pago en Puerta';
    }
}

function mostrarMensaje(metodo) {
    const estado = document.getElementById('metodo-estado');
    const mensaje = document.getElementById('metodo-mensaje');
    const resumen = document.getElementById('resumen-metodo');

    if (!estado || !mensaje) return;

    estado.classList.remove('hidden', 'bg-blue-100', 'text-blue-800', 'bg-green-100', 'text-green-800');

    if (metodo === 'TRANSFERENCIA') {
        estado.classList.add('bg-blue-100', 'text-blue-800');
        mensaje.textContent = 'üè¶ Transfiere el monto exacto y sube tu comprobante';
        resumen.textContent = 'üè¶ Transferencia bancaria';
    } else if (metodo === 'CONTRA_ENTREGA') {
        estado.classList.add('bg-green-100', 'text-green-800');
        mensaje.textContent = 'üíµ Pagar√°s en efectivo cuando recibas el producto';
        resumen.textContent = 'üíµ Pago en puerta';
    }

    estado.classList.remove('hidden');
}

// Validaci√≥n del formulario
document.getElementById('pedido-form').addEventListener('submit', function(e) {
    console.log('üìã Validando env√≠o...');

    if (!metodoActual) {
        e.preventDefault();
        alert('Selecciona un m√©todo de pago');
        return;
    }

    if (metodoActual === 'TRANSFERENCIA') {
        const comprobante = document.getElementById('comprobante');
        if (!comprobante || !comprobante.files.length) {
            e.preventDefault();
            alert('Sube el comprobante de transferencia');
            return;
        }
    }

    console.log('‚úÖ Enviando formulario...');

    // Deshabilitar bot√≥n
    const btn = document.getElementById('btn-confirmar');
    if (btn) {
        btn.disabled = true;
        btn.textContent = '‚è≥ Procesando...';
    }
});

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ P√°gina lista. Solo digitales:', soloDigitales);

    // Estado inicial
    const seccionDireccion = document.getElementById('seccion-direccion');
    if (!soloDigitales) {
        seccionDireccion.style.display = 'block';
    } else {
        seccionDireccion.style.display = 'none';
    }
});
</script>

{% endblock %}